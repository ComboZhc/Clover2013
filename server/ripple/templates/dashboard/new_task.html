{% extends "dashboard/base.html" %}

{% load tags %}
{% load staticfiles %}

{% block title %}
    新涟漪
{% endblock %}

{% block navbar_js %}
    $("li#link-new-task").addClass("active");
{% endblock %}

{% block page_title %}
<h3>新涟漪</h3>
{% endblock %}

{% block content %}
    <div id="trigger-panel">
        <div class="row-fluid">
            <div class="span12">
                <h3>选择信号</h3>
            </div>
        </div>
        {% for trigger in triggers %}
            {% if forloop.first %}<div class="row-fluid">{% elif forloop.counter0|divisibleby:3 %}</div><div class="row-fluid">{% endif %}
            {% trigger_grid trigger %}
            {% if forloop.last %}</div>{% endif %}
        {% endfor %}
    </div>

    <div id="action-panel" style="display:none">
        <div class="row-fluid">
            <div class="span12">
                <h3>选择行动</h3>
            </div>
        </div>
        {% for action in actions %}
            {% if forloop.first %}<div class="row-fluid">{% elif forloop.counter0|divisibleby:3 %}</div><div class="row-fluid">{% endif %}
            {% action_grid action %}
            {% if forloop.last %}</div>{% endif %}
        {% endfor %}
    </div>

    <div id="form-panel" style="display:none">
        <div class="row-fluid">
            <div class="span12">
                <h3>附加信息</h3>
            </div>
        </div>
        <form id="task_new_form" class="form-horizontal" method="post" action="">
            {% csrf_token %}
            {{ form.non_field_errors }}
            {% for field in form.visible_fields %}
                <div class="control-group">
                    {{ field.errors }}
                    {{ field|label_with_classes:"control-label"}} 
                    <div class="controls">
                        {{ field }}
                    </div>
                </div>
            {% endfor %}
            {% for field in form.hidden_fields %}
                <div style="display:none;">{{ field }}</div>
            {% endfor %}
            <input class="btn btn-large btn-primary" type="submit" value="创建" />
        </form>
    </div>

    <script>
    (function(){
        var updateTriggerKind = function(trigger_kind) {
            $("input#id_trigger_kind").val(trigger_kind);
            hints = $.hintForTrigger[trigger_kind];
            $("input#id_trigger_source").freezeInput(hints[0]);
            $("input#id_trigger_tag").freezeInput(hints[1]);
        };
        var updateActionKind = function(action_kind) {
            $("input#id_action_kind").val(action_kind);
            hints = $.hintForAction[action_kind];
            $("input#id_action_destination").freezeInput(hints[0]);
            $("textarea#id_action_content").freezeInput(hints[1]);
        };
        $(".trigger-grid").click(function() {
            $(".trigger-grid").removeClass("chosen");
            $(this).addClass("chosen");
            updateTriggerKind($(this).attr("id"));
            if ($("#action-panel").is(":hidden"))
                $("#action-panel").fadeIn("slow");
            $('html, body').animate({
                scrollTop: $("#action-panel").offset().top
            }, 1000);
        });
        $(".action-grid").click(function() {
            $(".action-grid").removeClass("chosen");
            $(this).addClass("chosen");
            updateActionKind($(this).attr("id"));
            if ($("#form-panel").is(":hidden"))
                $("#form-panel").fadeIn("slow");
            $('html, body').animate({
                scrollTop: $("#form-panel").offset().top
            }, 1000);
        });
        $("#id_action_content").tooltip({"title":"title"});
    }).call(this);
    </script>



{% endblock %}